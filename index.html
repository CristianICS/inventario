<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Forest Inventory</title>
    <link rel="stylesheet" href="style.css" />
    <script src="app.js"></script>
    <script src="listado_especies.js"></script>
    <link rel="manifest" href="manifest.json" />
  </head>
  <body>
    <h1 id="app-title">Forest Inventory</h1>
    <form id="inventory-form">
      <fieldset>
        <legend id="app-main-form-title">Init new inventory</legend>
        <p>
          <label for="inventory-name">Name</label>
          <input type="text" id="inventory-name" class="inv-mtd" required />
          <label for="inventory-creator">Creator</label>
          <input type="text" id="inventory-creator" class="inv-mtd" required />
        </p>
        <p>
          <label for="inventory_init_point">Initial point</label>
          <input type="number" id="inventory-init_point" class="inv-mtd" required />
          <label for="inventory-stop_point">Final point</label>
          <input type="number" id="inventory-stop_point" class="inv-mtd" required />
        </p>
      </fieldset>
      <p>
        <button type="submit" id="app-main-form-btn">Create inventory</button>
      </p>
    </form>
    <section id="saved-inventories"></section>
    <section id="inventory-sheet"></section>
    <form id="rows-form" style="display:none;" autocomplete="off">
      <fieldset id="rows-fieldset" class="rows-fieldset">
        <legend id="rows-title">Rows</legend>
      </fieldset>
      <p>
        <button type="button" id="row-btn-add">Add row</button>
        <button type="button" id="row-btn-del">Delete row</button>
        <button type="button" id="row-btn-img">Add picture</button>
      </p>
    </form>
    <script>
      // Handle SW if "serviceWorker" exist
      if ("serviceWorker" in navigator) {
        // Register the app's service worker
        // Passing the filename where that worker is defined.
        navigator.serviceWorker.register("sw.js").then(
          (registration) => {
            console.log("Service worker registration successful:", registration);
          },
          (error) => {
            console.error(`Service worker registration failed: ${error}`);
          },
        );
      } else {
        console.error("Service workers are not supported.");
      }
    </script>
    <script>
      // Init global inventories class
      var inventories = new Inventories();
      // Init Database
      const dbHandler = new IndexedDBHandler('forestInventory');
      // Show the saved inventories
      dbHandler.init().then(async (db) => {
        await inventories.load(db);
        inventories.show();
      });

      // Handle inventory form/rows controls
      const newInvFormEl = document.getElementsByTagName("form")[0];
      newInvFormEl.addEventListener("submit", async (event) => {
        // Prevent the form from submitting to the server
        // since everything is client-side.
        event.preventDefault();

        // Save inventary metadata inside IDB
        let metadata = document.querySelectorAll('.inv-mtd');
        await inventories.save(metadata, dbHandler);
        await inventories.load(dbHandler);
        
        // Check if there is any open inventory and save its rows too.
        if (!isNaN(inventories.activeid)) {
          // Initialize the 'rows' object and collect the displayed rows
          let rows = new Rows();
          rows.collect();
          console.log(rows.arrays);
          rows.save(inventories.activeid, dbHandler);
          // Collect again the rows from IDB to show its ids
          await rows.init(inventories.activeid, dbHandler);
          rows.ls();
          rows.show();
        }
        else {
          // Show the 'saved  inventories' panel refreshed
          inventories.show();
        }
      });

      // Get saved inventories buttons parent HTML block
      const savedInventoriesEl = document.getElementById("saved-inventories");
      // Handle saved inventories functions
      savedInventoriesEl.addEventListener("click", async (event) => {
        // Check if user has clicked on predefined controls
        const idParts = event.target.id.split('-');
        switch (idParts[0]){
          case 'open':
            // Get inventory id (inside button id)
            var id = parseInt(idParts[1]);
            // Select inventory by ID and populate the info inside the form
            inventories.selectById(id).populate();
            // Update the activate ID
            inventories.activeid = id;
            // Update UI
            // Hide the saved inventories form
            document.getElementById('saved-inventories').innerHTML = "";
            // Change #app-main-form-title
            let editTitle = "Fill in"
            document.getElementById('app-main-form-title').textContent = editTitle;
            // Change #app-main-form-btn text
            document.getElementById('app-main-form-btn').textContent = "Save";
            // Display the row panel
            document.getElementById('rows-form').style.display = 'block';
            // Show rows
            let rows = new Rows();
            await rows.init(id, dbHandler);
            rows.show();
            break;
          case 'download':
            alert('Download functionality is not available yet.');
            break;
          case 'delete':
            // Get inventory id (inside button id)
            var id = parseInt(idParts[1]);
            // Select inventory by ID and delete it
            await inventories.delete(id, dbHandler);
            // Show the inventories again
            inventories.show();
            break;
        }
      });
      
      // Save the container with row controls
      const rowsEl = document.getElementById("rows-form");
      // Add listeners to handle row controls
      rowsEl.addEventListener("click", async (event) => {
        // The buttons id action is stored in the string row-btn-action
        const objIdParts = event.target.id.split('-');
        // Check only the action buttons
        if (objIdParts.length == 3) {
          // Handle it
          switch (objIdParts[2]) {
            case 'add':
              // Init a new Rows element to handle rows
              var rows = new Rows()
              // Retrieve rows inside the form
              rows.collect();
              // Add an empty row
              rows.emptyRow();
              // Init the rows form again (clean)
              rows.ls();
              // Show the new rows (ancient ones plus new empty one)
              rows.show();
              break;
            case 'del':
              // Init a new Rows element to handle rows
              var rows = new Rows();
              // Retrieve selected rows
              rows.collect(true);
              // Exit the function if there are no rows selected.
              if (rows.arrays.length == 0) {return alert('Select a row.');}
              // Delete above rows
              await rows.delete(dbHandler);
              // Collect again and show to reflect the changes in row numbers
              rows.collect();
              // Init the rows form again (clean)
              rows.ls();
              rows.show();
              break;
            case 'img':
              alert('Add image function is not available yet.');
          }
        }

        // Select/Unselect a row
        if(objIdParts[0] == 'rown') {
          // Check if it's already selected
          const isSelected = event.target.classList.contains('selected');
          if (isSelected) {
            // Unselect
            event.target.classList.remove('selected');
          } else {
            // Change the background color
            event.target.classList.add('selected');
          }
        }
      });

      // When click on app title, go to the initial UI
      var appTitle = document.querySelector('#app-title');
      appTitle.addEventListener('click', (e) => {
        // Confirm to prevent close an open inventory with unsaved data
        if (confirm('Unsaved data will be erased. Are you sure?')) {
          // Update UI
          // Open the saved inventories form
          document.getElementById('saved-inventories').innerHTML = "";
          // Change #app-main-form-title
          let editTitle = "Init new inventory"
          document.getElementById('app-main-form-title').textContent = editTitle;
          // Change #app-main-form-btn text
          document.getElementById('app-main-form-btn').textContent = "Create Inventory";
          // Display the saved inventories panel
          inventories.show();
        }
      })

      /*
      // Listen to form submissions.
      newInvFormEl.addEventListener("submit", (event) => {
        // Prevent the form from submitting to the server
        // since everything is client-side.
        event.preventDefault();

        // Detect if submit button is for saving the metadata and the rows
        if (event.submitter.id == "save-btn") {
          // Get rows
          const userRows = document.querySelector(`#rown-${this.rown}`);
          // Save rows inside IndexDB
          userRows.forEach((row) => {
            saveRow(row);
          });
        } else {
          // Save inventory metadata
          // Get parameters from the form.
          let metadata = document.querySelectorAll('.inv-mtd');
          // Update form metadata
          saveInventory(metadata, dbHandler);
        }
      });

      // Add listeners to handle row buttons and row selection
      const rowsEl = document.getElementById("rows-form");
      rowsEl.addEventListener("click", async (event) => {
        // The buttons id action is stored in the string row-btn-action
        const objIdParts = event.target.id.split('-');
        // Check only the action buttons
        if (objIdParts.length == 3) {
          // Get the action and handle it
          switch (objIdParts[2]) {
            case 'add':
              // Get the activated inventory
              const activatedInv = savedInventories.filter((el) => {
                return el.activated});
              // Add an empty row
              new Row(activatedInv[0].id);
              showRows();
              break;
            case 'del':
              // Catch the selected rows
              const selectedRows = document.querySelectorAll('.selected');
              // Exit the function if there is no rows selected.
              if (selectedRows.length == 0) {return alert('Select a row.');}

              // Set a confirm message to display before delete the rows
              let msg = `It\'s going to delete ${selectedRows.length} row.` +
                ' Are you sure?'
              const activeInv = savedInventories.filter((el) => {
                return el.activated})[0];
              if (confirm(msg)){
                // Delete selected rows
                selectedRows.forEach(async (row) => {
                  deleteRow(row.dataset.id, dbHandler);
                });
                // Refresh rows
                await populateRows(activeInv.id, dbHandler);
                showRows();
              }
              break;
          }
        }

        // Select/Unselect a row
        if(objIdParts[0] == 'rown') {
          // Check if it's already selected
          const isSelected = event.target.classList.contains('selected');
          if (isSelected) {
            // Unselect
            event.target.classList.remove('selected');
          } else {
            // Change the background color
            event.target.classList.add('selected');
          }
        }
      })
      */
    </script>
  </body>
</html>